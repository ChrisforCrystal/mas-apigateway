# 功能规格说明书：动态配置 (Dynamic Configuration)

**功能分支**: `002-dynamic-config`
**创建日期**: 2025-12-21
**状态**: 草案
**输入**: 路线图特性 002 - "定义 Listener, Route, Cluster 数据模型。实现动态配置热加载。"

## 用户场景与测试

### 用户故事 1 - 数据模型定义 (优先级: P0)

作为一名开发者，我需要 `Listener`（监听器）、`Route`（路由）和 `Cluster`（集群）的清晰 Protocol Buffer 定义，以便配置网关如何代理流量。

**优先级理由**: 没有数据模型，我们就无法传递配置。

**独立测试**:

1. `protoc` 能编译出有效的 Go 和 Rust 结构体。
2. 结构体包含预期字段（Listener: 端口/地址, Route: 路径匹配/集群引用, Cluster: 端点列表）。

**验收场景**:

1. **给定** `proto/config.proto`，**当** 编译时，**则** 生成 `Listener`, `Route`, `Cluster` 消息。
2. **给定** 特性 001 中的 `ConfigSnapshot`，**当** 更新时，**则** 它包含上述资源的列表。

---

### 用户故事 2 - 控制面配置源 (优先级: P1)

作为一名系统运维，我希望定义一个静态配置文件（例如 `config.yaml`），控制面能够读取并推送给数据面，这样我无需重新编译代码就能管理路由。

**优先级理由**: 在没有完整 UI/DB 之前，实现基于文件的“动态”行为。

**独立测试**:

1. 创建包含 1 个监听器和 1 个路由的 `config.yaml`。
2. 控制面日志显示 "Loaded config version X"。
3. 数据面日志显示 "Received config version X with 1 listeners"。

**验收场景**:

1. **给定** 一个 `config.yaml` 配置路由 `/api` -> `1.1.1.1`，**当** CP 启动时，**则** 它将此快照发送给 DP。
2. **给定** 一个运行中的 CP，**当** `config.yaml` 发生变化时，**则** CP 重新加载并推送新快照（CP 侧热加载）。

---

### 用户故事 3 - 数据面热加载 (优先级: P1)

作为一名系统架构师，我希望数据面能够立即应用配置更改（例如新的端口监听或新的上游），且不中断现有连接。

**优先级理由**: 网关的核心价值主张。

**独立测试**:

1. 以空配置启动 DP（无监听）。
2. 推送包含 6188 端口监听的配置。
3. `curl localhost:6188` 成功。
4. 推送更新上游的配置。
5. `curl localhost:6188` 反映新的上游行为。

**验收场景**:

1. **给定** 运行中的 Pingora 引擎，**当** 收到 `ConfigSnapshot` 时，**则** 它更新内部路由表。
2. **给定** 新的 Listener 定义（例如端口 9090），**当** 应用时，**则** Pingora 开始监听 9090。

---

## 需求

### 功能需求

- **FR-001**: 必须定义 `Listener` (地址, 端口), `VirtualHost` (域名), `Route` (前缀匹配), 和 `Cluster` (后端端点)。
- **FR-002**: 控制面必须支持监听本地 YAML 文件的变化（基于文件的 xDS 源）。
- **FR-003**: 数据面必须实现针对 Cluster 的 `pingora::lb::LoadBalancer`。
- **FR-004**: 数据面必须实现一个路由表，将 `Host` + `Path` 映射到 `Cluster`。

### 架构约束

- **AC-001**: 配置更新必须是原子的（每个快照全量更新，要么全成功要么全失败）。
- **AC-002**: 数据面在切换配置时必须保证线程安全（使用 Pingora 的 `ArcSwap` 或类似机制）。

## 成功标准

- **SC-001**: 端到端配置传播延迟 < 200ms (文件保存 -> DP 应用)。
- **SC-002**: 成功代理基于动态加载路由的请求。
