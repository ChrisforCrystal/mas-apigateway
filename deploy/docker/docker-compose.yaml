version: "3.8"

services:
  # --- Infrastructure ---
  redis:
    image: redis:alpine
    container_name: mas-redis
    ports:
      - "6379:6379"

  postgres:
    image: postgres:alpine
    container_name: mas-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: mydb
    ports:
      - "5432:5432"
    # Init script to create table (optional, for now we assume manual or pre-baked)
    # For demo we can map a simple SQL if needed, but 'users' table is needed.
    # Let's trust user creates it or we map a volume later.
    # For now, simplistic.
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  mysql:
    image: mysql:8.0
    container_name: mas-mysql
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: mydb
    ports:
      - "3306:3306"
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 5s
      retries: 10

  upstream:
    image: ealen/echo-server:latest
    container_name: mas-upstream
    ports:
      - "9000:80"

  # --- Core Components ---
  control-plane:
    build:
      context: ../../control-plane
    container_name: mas-control-plane
    environment:
      - AGW_CONFIG_PATH=/etc/mas-agw/config.yaml
    volumes:
      - ../../control-plane/config-docker.yaml:/etc/mas-agw/config.yaml
    ports:
      - "18000:18000"
    depends_on:
      redis:
        condition: service_started

  data-plane:
    build:
      context: ../../
      dockerfile: data-plane/Dockerfile
    container_name: mas-data-plane
    environment:
      - AGW_CONTROL_PLANE_URL=http://control-plane:18000
      - RUST_LOG=debug
    ports:
      - "6188:6188"
      - "6443:6443"
    depends_on:
      - control-plane
      - redis
      - postgres
      - mysql
      - upstream

  ebpf-agent:
    build:
      context: ../../
      dockerfile: ebpf-agent/Dockerfile
    container_name: mas-ebpf-agent
    privileged: true
    pid: host
    network_mode: host
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - /sys/fs/bpf:/sys/fs/bpf:rw
    environment:
      - RUST_LOG=info
