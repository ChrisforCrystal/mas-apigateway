# AGW éªŒè¯æŒ‡å—

ä¸ºäº†é€‚åº”ä¸åŒçš„å¼€å‘é˜¶æ®µå’Œæµ‹è¯•éœ€æ±‚ï¼Œæˆ‘ä»¬å°†éªŒè¯åˆ†ä¸ºä¸‰ç§åœºæ™¯ã€‚è¯·æ ¹æ®æ‚¨çš„ç›®çš„é€‰æ‹©åˆé€‚çš„æ¨¡å¼ã€‚

---

## åœºæ™¯ä¸€ï¼šæœ¬åœ°å¼€å‘æ¨¡å¼ (Local Development)

**ğŸ¯ éªŒè¯ç›®æ ‡**:

- **åŸºç¡€ä¸šåŠ¡é€»è¾‘**: è·¯ç”±è½¬å‘ã€è¯·æ±‚å¤´å¤„ç†ã€‚
- **Wasm æ’ä»¶**: éªŒè¯æ’ä»¶èƒ½å¦æ­£ç¡®åŠ è½½å’Œæ‹¦æˆªè¯·æ±‚ã€‚
- **çƒ­æ›´æ–°**: ä¿®æ”¹ `config.yaml` æˆ– Wasm æ–‡ä»¶ï¼ŒéªŒè¯æ— éœ€é‡å¯å³å¯ç”Ÿæ•ˆã€‚

**âœ… é€‚ç”¨åœºæ™¯**: æ—¥å¸¸ç¼–ç ã€å¿«é€Ÿè°ƒè¯• (Debug)ã€åŠŸèƒ½å¼€å‘ã€‚
**âš ï¸ å±€é™æ€§**: æ— æ³•éªŒè¯ TLS (å›  macOS/Linux OpenSSL å·®å¼‚)ï¼ŒK8s äº¤äº’ä»…é™äºè¯»å– kubeconfigã€‚

### æ“ä½œæ­¥éª¤

1. **å¯åŠ¨æ§åˆ¶é¢ (Control Plane)**:
   > âš ï¸ **æ³¨æ„**: æœ¬åœ°è¿è¡Œæ—¶å¦‚æœç¼ºå°‘ K8s è¿æ¥ï¼ŒHTTPS ç›‘å¬å™¨å› ç¼ºå°‘è¯ä¹¦å°†æ— æ³•å¯åŠ¨ï¼Œä½†è¿™ä¸å½±å“ HTTP (6188) åŠŸèƒ½éªŒè¯ã€‚
   ```bash
   cd control-plane
   # ç¡®ä¿ config.yaml å­˜åœ¨
   go run cmd/server/main.go
   ```
2. **å¯åŠ¨æ•°æ®é¢ (Data Plane)**:
   > æ•°æ®é¢ä¼šå°è¯•è¿æ¥æ§åˆ¶é¢è·å–åŠ¨æ€é…ç½®ã€‚
   ```bash
   cd data-plane
   # æŒ‡å®šæ§åˆ¶é¢åœ°å€
   export AGW_CONTROL_PLANE_URL="http://localhost:18000"
   # å¼€å¯è¯¦ç»†æ—¥å¿—
   export RUST_LOG=debug
   cargo run
   ```
3. **æµ‹è¯•**:
   - HTTP è¯·æ±‚: `curl -v http://localhost:6188/new`
   - **Wasm æ’ä»¶é…ç½®ä¸éªŒè¯**:
     1. **ç¼–è¯‘æ’ä»¶**:
        ```bash
        cd plugins/deny-all
        cargo build --target wasm32-unknown-unknown --release
        ```
     2. **ä¿®æ”¹é…ç½®** (`control-plane/config.yaml`):
        åœ¨è·¯ç”±ä¸‹æ·»åŠ  `plugins` å­—æ®µ (è¯·ä½¿ç”¨ç»å¯¹è·¯å¾„):
        ```yaml
        routes:
          - match: "/new"
            cluster: "my-local-cluster"
            plugins:
              - name: "deny-curl"
                wasm_path: "/Create/Absolute/Path/To/plugins/deny-all/target/wasm32-unknown-unknown/release/deny_all.wasm"
        ```
     3. **éªŒè¯æ‹¦æˆª**:
        - `curl -v http://localhost:6188/new` -> **403 Forbidden** (å› ä¸º User-Agent åŒ…å« curl)
        - `curl -v -H "User-Agent: browser" http://localhost:6188/new` -> **200 OK**

---

## åœºæ™¯äºŒï¼šDocker ç¯å¢ƒéªŒè¯ (Docker Environment)

**ğŸ¯ éªŒè¯ç›®æ ‡**:

- **TLS ç»ˆç»“ (HTTPS)**: éªŒè¯åœ¨æ ‡å‡† Linux/OpenSSL ç¯å¢ƒä¸‹è¯ä¹¦åŠ è½½å’Œæ¡æ‰‹æ˜¯å¦æ­£å¸¸ã€‚
- **ç¯å¢ƒä¸€è‡´æ€§**: éªŒè¯æ„å»ºäº§ç‰© (`Dockerfile`) å¯åœ¨ Linux å®¹å™¨ä¸­æ­£å¸¸è¿è¡Œã€‚

**âœ… é€‚ç”¨åœºæ™¯**: æäº¤ä»£ç å‰éªŒè¯ã€è§£å†³è·¨å¹³å°åº“å…¼å®¹æ€§é—®é¢˜ (å¦‚ TLS æŠ¥é”™)ã€‚

### æ“ä½œæ­¥éª¤

1. **æ„å»ºé•œåƒ**:
   ```bash
   make docker-build
   # æˆ–è€…: docker build -f data-plane/Dockerfile -t masapigateway/data-plane:latest .
   ```
2. **è¿è¡Œæ•°æ®é¢å®¹å™¨**:
   ```bash
   # å‡è®¾æ§åˆ¶é¢ä»åœ¨æœ¬åœ°è¿è¡Œ (ç«¯å£ 18000)
   docker run --rm -p 6188:6188 -p 6443:6443 \
     -e AGW_CONTROL_PLANE_URL="http://host.docker.internal:18000" \
     masapigateway/data-plane:latest
   ```
3. **æµ‹è¯• HTTPS**:
   ```bash
   curl -k -v https://localhost:6443/secure
   ```
   _åœ¨æ­¤æ¨¡å¼ä¸‹ï¼ŒTLS æ¡æ‰‹åº”æˆåŠŸã€‚_

---

## åœºæ™¯ä¸‰ï¼šé›†ç¾¤é›†æˆéªŒè¯ (K8s Cluster)

**ğŸ¯ éªŒè¯ç›®æ ‡**:

- **Operator æ¨¡å¼**: éªŒè¯æ§åˆ¶é¢èƒ½å¦æ­£ç¡® watch K8s èµ„æº (Services, Secrets, CRDs)ã€‚
- **RBAC æƒé™**: éªŒè¯ ServiceAccount æ˜¯å¦æœ‰æƒé™è¯»å–èµ„æºã€‚
- **CRD åŠ¨æ€è·¯ç”±**: éªŒè¯ `GatewayRoute` è‡ªå®šä¹‰èµ„æºçš„ç”Ÿæ•ˆæƒ…å†µã€‚
- **å…¨é“¾è·¯éƒ¨ç½²**: éªŒè¯ Deployment/Service/ConfigMap çš„å®šä¹‰æ˜¯å¦æ­£ç¡®ã€‚

**âœ… é€‚ç”¨åœºæ™¯**: é›†æˆæµ‹è¯•ã€ç”Ÿäº§éƒ¨ç½²å‰éªŒæ”¶ã€éªŒè¯ K8s ç‰¹æœ‰åŠŸèƒ½ã€‚

### æ“ä½œæ­¥éª¤

1. **æ„å»ºé•œåƒ**:
   ```bash
   make docker-build
   # æ„å»º Control Plane å’Œ Data Plane é•œåƒ
   # å¦‚æœä½¿ç”¨ Kindï¼Œè¿˜éœ€è¦åŠ è½½é•œåƒ: kind load docker-image masapigateway/control-plane:latest masapigateway/data-plane:latest
   ```
2. **éƒ¨ç½² Operator**:
   ```bash
   make deploy
   # è¿™å°†è‡ªåŠ¨åº”ç”¨ RBAC, CRD, Deployment åˆ°å½“å‰ K8s é›†ç¾¤
   ```
3. **åˆ›å»ºæµ‹è¯•èµ„æº**:
   ```bash
   # 1. åˆ›å»º TLS Secret
   kubectl create secret tls my-tls-secret --cert=server.crt --key=server.key
   # 2. åˆ›å»ºåŠ¨æ€è·¯ç”± (CRD)
   kubectl apply -f k8s-test-crd.yaml
   ```
4. **éªŒè¯**:

   - **æŸ¥çœ‹æ—¥å¿—**: `kubectl logs -l app=mas-agw-control-plane` ç¡®è®¤ç›‘å¬åˆ°äº‹ä»¶ã€‚
   - **è®¿é—®æœåŠ¡**:

     ```bash

     kubectl port-forward svc/mas-agw-data-plane 6188:80
     curl -k -v https://localhost:6443/dynamic
     # ç«¯å£è½¬å‘åˆ°æœ¬åœ°è¿›è¡Œæµ‹è¯•
     kubectl port-forward svc/mas-agw-data-plane 6443:443
     curl -k -v https://localhost:6443/dynamic
     ```

---

## æ€»ç»“

| éªŒè¯æ¨¡å¼     | å…³æ³¨ç‚¹              | æ ¸å¿ƒä¼˜åŠ¿               |
| :----------- | :------------------ | :--------------------- |
| **æœ¬åœ°å¼€å‘** | ä¸šåŠ¡é€»è¾‘ã€Wasm      | å¼€å‘é€Ÿåº¦å¿«ï¼ŒDebug æ–¹ä¾¿ |
| **Docker**   | TLSã€äºŒè¿›åˆ¶å…¼å®¹æ€§   | ç¯å¢ƒçº¯å‡€ï¼Œæ¶ˆé™¤ç³»ç»Ÿå·®å¼‚ |
| **K8s é›†ç¾¤** | Operatorã€CRDã€RBAC | çœŸå®åœºæ™¯ï¼Œé›†æˆæµ‹è¯•     |

---

## è¡¥å……ï¼šè¯ä¹¦ä¸å®‰å…¨æ¦‚å¿µ (Certificate Management)

### 1. æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

åœ¨ TLS/HTTPS é…ç½®ä¸­ï¼Œé€šå¸¸æ¶‰åŠä»¥ä¸‹ä¸‰ç§æ–‡ä»¶ï¼š

| æ–‡ä»¶åç¼€        | å…¨ç§°                   | è¯´æ˜                                                           | è°æŒæœ‰                        |
| :-------------- | :--------------------- | :------------------------------------------------------------- | :---------------------------- |
| **.key**        | Private Key (ç§é’¥)     | **æ ¸å¿ƒæœºå¯†**ã€‚ç”¨äºè§£å¯†æ•°æ®å’Œæ•°å­—ç­¾åã€‚æ³„éœ²æ„å‘³ç€å®‰å…¨é˜²çº¿å´©å¡Œã€‚ | **ä»…ç½‘å…³æœåŠ¡ç«¯** (Data Plane) |
| **.crt / .pem** | Certificate (å…¬é’¥è¯ä¹¦) | åŒ…å«å…¬é’¥å’Œèº«ä»½ä¿¡æ¯ã€‚ç›¸å½“äºâ€œèº«ä»½è¯â€ï¼Œç”¨äºå‘å¯¹æ–¹è¯æ˜èº«ä»½ã€‚       | **æœåŠ¡ç«¯æŒæœ‰ï¼Œå®¢æˆ·ç«¯éªŒè¯**    |
| **CA**          | Certificate Authority  | ç­¾å‘è¯ä¹¦çš„æƒå¨æœºæ„ã€‚CA çš„æ ¹è¯ä¹¦ç”¨äºéªŒè¯å…¶ä»–è¯ä¹¦çš„åˆæ³•æ€§ã€‚      | **å®¢æˆ·ç«¯** (æ”¾å…¥ä¿¡ä»»åº“)       |

### 2. æœ¬é¡¹ç›®è¯ä¹¦æµè½¬

`masapigateway` é‡‡ç”¨ **Server-Side TLS (å•å‘è®¤è¯)** æ¨¡å¼ï¼š

1.  **ç”Ÿæˆ (Generate)**: ç®¡ç†å‘˜ä½¿ç”¨ `openssl` ç”Ÿæˆ `server.key` (ç§é’¥) å’Œ `server.crt` (è‡ªç­¾è¯ä¹¦)ã€‚
2.  **ä¸Šä¼  (Upload)**: é€šè¿‡ `kubectl create secret generic` å°†å…¶å­˜å…¥ Kubernetes Secretã€‚
3.  **åˆ†å‘ (Distribute)**: Control Plane è¯»å– Secret å¹¶é€šè¿‡ gRPC å…¨é‡æ¨é€ç»™ Data Planeã€‚
4.  **ä½¿ç”¨ (Usage)**: Data Plane å¯åŠ¨ HTTPS ç›‘å¬ã€‚
5.  **éªŒè¯ (Verify)**: Client (curl) å‘èµ·è¯·æ±‚ï¼Œç½‘å…³å‡ºç¤º `server.crt`ã€‚

### 3. å¦‚ä½•ç”Ÿæˆæµ‹è¯•è¯ä¹¦

æˆ‘ä»¬åœ¨ `Makefile` ä¸­å¹¶æœªé›†æˆç”Ÿæˆé€»è¾‘ï¼Œä½ éœ€è¦æ‰‹åŠ¨ç”Ÿæˆï¼š

```bash
# 1. ç”Ÿæˆç§é’¥
openssl genrsa -out server.key 2048

# 2. ç”Ÿæˆè‡ªç­¾è¯ä¹¦ (æœ‰æ•ˆæœŸ 365 å¤©)
# -nodes: ä¸åŠ å¯†ç§é’¥
# -subj: é¿å…äº¤äº’å¼è¾“å…¥ä¿¡æ¯ï¼ŒCN (Common Name) å¿…é¡»åŒ¹é…åŸŸå (è¿™é‡Œæ˜¯ localhost)
openssl req -new -x509 -sha256 -key server.key -out server.crt -days 365 -nodes \
  -subj "/C=CN/ST=Beijing/L=Beijing/O=MasAllSome/OU=Gateway/CN=localhost"
```

### 4. å¸¸è§é—®é¢˜

- **ä¸ºä»€ä¹ˆ curl éœ€è¦ `-k`?**
  å› ä¸ºæˆ‘ä»¬ä½¿ç”¨è‡ªç­¾è¯ä¹¦ï¼Œcurl é»˜è®¤ä¸ä¿¡ä»»éæƒå¨ CA ç­¾å‘çš„è¯ä¹¦ã€‚`-k` æ„ä¸º "Insecure"ï¼Œå³è·³è¿‡éªŒè¯ã€‚
- **å¦‚ä½•ä¸åŠ  `-k` ä¹Ÿèƒ½è®¿é—®ï¼Ÿ**
  å®¢æˆ·ç«¯éœ€è¦æ˜¾å¼ä¿¡ä»»ä½ çš„è¯ä¹¦ï¼š
  ```bash
  curl --cacert server.crt https://localhost:6443/
  ```

### 5. æ·±å…¥ç†è§£ CA ä¸ä¿¡ä»»é“¾

é’ˆå¯¹ "CA åœ¨é€šä¿¡ä¸­èµ·ä»€ä¹ˆä½œç”¨" è¿™ä¸€å¸¸è§ç–‘é—®ï¼š

- **CA çš„è§’è‰²**: ç±»ä¼¼äºç°å®ç”Ÿæ´»ä¸­çš„ **â€œå…¬è¯å¤„â€** æˆ– **â€œèº«ä»½è¯ç­¾å‘æœºå…³â€**ã€‚
  - å®ƒ**ä¸å‚ä¸**ä½ ï¼ˆå®¢æˆ·ç«¯ï¼‰å’Œç½‘å…³ï¼ˆæœåŠ¡ç«¯ï¼‰çš„æ—¥å¸¸åŠ å¯†é€šä¿¡ï¼ˆæ•°æ®ä¸ç»è¿‡ CAï¼‰ã€‚
  - å®ƒçš„æ ¸å¿ƒä½œç”¨æ˜¯ **â€œä¿¡ç”¨èƒŒä¹¦â€**ï¼šåœ¨æ¡æ‰‹é˜¶æ®µï¼Œè¯æ˜ç½‘å…³å‡ºç¤ºçš„è¯ä¹¦æ˜¯åˆæ³•çš„ã€‚
- **ä¿¡ä»»çš„ä¼ é€’é€»è¾‘**:
  1.  **å®¢æˆ·ç«¯ä¿¡ä»» CA**: ä½ æ‰‹åŠ¨å°† CA çš„æ ¹è¯ä¹¦ï¼ˆRoot Certï¼‰åŠ å…¥åˆ°æ“ä½œç³»ç»Ÿæˆ–æµè§ˆå™¨çš„ **â€œå—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„â€** åˆ—è¡¨ä¸­ã€‚
  2.  **CA ä¿¡ä»»ç½‘å…³**: CA ç”¨è‡ªå·±çš„ç§é’¥ç»™ç½‘å…³çš„è¯ä¹¦ï¼ˆserver.crtï¼‰è¿›è¡Œäº†**æ•°å­—ç­¾å**ã€‚
  3.  **ç»“æœ**: å½“ä½ è®¿é—®ç½‘å…³æ—¶ï¼Œæµè§ˆå™¨çœ‹åˆ°ç½‘å…³è¯ä¹¦ä¸Šæœ‰ CA çš„ç­¾åï¼Œå› ä¸ºä½ ä¿¡ä»» CAï¼Œæ‰€ä»¥ä½ ä¹Ÿè‡ªåŠ¨ä¿¡ä»»äº†è¿™ä¸ªç½‘å…³ã€‚
- **å…³äºâ€œå¸¦ç€å…¬é’¥è®¿é—®â€**:
  - å®¢æˆ·ç«¯**ä¸éœ€è¦**å‘é€å…¬é’¥ç»™ç½‘å…³ã€‚
  - å®¢æˆ·ç«¯ä½¿ç”¨çš„æ˜¯**æœ¬åœ°ä¿¡ä»»åº“ä¸­ CA çš„å…¬é’¥**ï¼Œå»è§£å¯†å’ŒéªŒè¯ç½‘å…³è¯ä¹¦ä¸Šçš„ç­¾åã€‚ä¸€æ—¦éªŒè¯é€šè¿‡ï¼Œå°±å»ºç«‹è¿æ¥ã€‚
